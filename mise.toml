[settings]
auto_install = true

[tools]
pre-commit = '4.3'
git-cliff = '2.7.0'
age = '1.2'
sops = '3.11'
shfmt = '3.12'
yamlfmt = '0.20'
opentofu = '1.11'
terraform-docs = '0.21.0'
tflint = '0.56.0'
python = '3.13'

[tasks.rm-cache]
run = 'find . -type d -name ".terramate-cache" -prune -exec rm -rf {} \;'

[tasks.rm-terraform]
run = 'find . -type d -name ".terraform" -prune -exec rm -rf {} \;'

[tasks.rm-lock]
run = 'find . -type f -name ".terraform.lock.hcl" -prune -exec rm -rf {} \;'

[tasks.rm-all]
run = '''
find . -type d -name ".terramate-cache" -prune -exec rm -rf {} \;
find . -type d -name ".terraform" -prune -exec rm -rf {} \;
find . -type f -name ".terraform.lock.hcl" -prune -exec rm -rf {} \;
find . -type f -name "terraform.tfstate*" -prune -exec rm -rf {} \;
'''

[tasks."test:examples"]
description = "Init and validate all examples"
run = '''
for dir in examples/*/; do
  echo "==> Validating $dir"
  tofu -chdir="$dir" init -upgrade -backend=false
  tofu -chdir="$dir" validate
done
'''

[tasks."test:complete"]
description = "Init and validate the complete example with the example SSH key"
run = '''
tofu -chdir=examples/complete init -upgrade -backend=false
tofu -chdir=examples/complete validate -var "ssh_public_key=$(cat examples/complete/example_key.pub)"
'''

[tasks.changelog]
description = "Update CHANGELOG.md (fetches all tags first)"
run = '''
git-cliff --config .cliff.toml --output CHANGELOG.md
'''
