validate:opentofu:
  stage: validate
  image:
    name: ghcr.io/opentofu/opentofu:1.11
    entrypoint: [""]
  script:
    - tofu init -backend=false
    - tofu validate
    - tofu fmt -check -recursive

validate:tflint:
  stage: validate
  image:
    name: ghcr.io/terraform-linters/tflint:v0.56.0
    entrypoint: [""]
  script:
    - tflint --init
    - tflint --recursive

verify:changelog:
  stage: validate
  image: ubuntu:24.04
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl ca-certificates > /dev/null 2>&1
    - curl -sSf https://mise.run | MISE_VERSION=${MISE_VERSION} sh
    - eval "$(~/.local/bin/mise activate bash)"
    - mise install git-cliff
  script:
    - cp CHANGELOG.md CHANGELOG.md.bak
    - git-cliff --config .cliff.toml --output CHANGELOG.md
    - diff CHANGELOG.md CHANGELOG.md.bak

create:release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  needs:
    - pre-commit
    - validate:opentofu
    - validate:tflint
    - verify:changelog
  before_script:
    - apk add --no-cache curl bash git
    - curl -sSf https://mise.run | sh
    - eval "$(~/.local/bin/mise activate bash)"
    - mise install git-cliff
  script:
    - git-cliff --config .cliff.toml --latest --strip header > release_notes.md
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: ./release_notes.md
    assets:
      links:
        - name: "Source code (tar.gz)"
          url: "${CI_PROJECT_URL}/-/archive/${CI_COMMIT_TAG}/${CI_PROJECT_NAME}-${CI_COMMIT_TAG}.tar.gz"
          link_type: package
        - name: "Source code (zip)"
          url: "${CI_PROJECT_URL}/-/archive/${CI_COMMIT_TAG}/${CI_PROJECT_NAME}-${CI_COMMIT_TAG}.zip"
          link_type: package
        - name: "CHANGELOG"
          url: "${CI_PROJECT_URL}/-/blob/${CI_COMMIT_TAG}/CHANGELOG.md"
          link_type: other
